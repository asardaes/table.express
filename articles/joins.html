<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Joining verbs for data.table • table.express</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Joining verbs for data.table">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">table.express</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/table.express.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/joins.html">Joining verbs for data.table</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/asardaes/table.express">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Joining verbs for data.table</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/asardaes/table.express/blob/master/vignettes/joins.Rmd"><code>vignettes/joins.Rmd</code></a></small>
      <div class="hidden name"><code>joins.Rmd</code></div>

    </div>

    
    
<p>Almost all joins between 2 <code>data.table</code>s use a notation where one of them is used as <code>i</code> in a frame applied to the other, and the joining columns are specified with the <code>on</code> parameter. However, in addition to the “basic” joins, <code>data.table</code> allows for special cases like rolling joins, summarizing while joining, non-equi joins, etc. This vignette will describe the notation to apply these joins with verbs defined in <code>table.express</code>, which, like the <a href="https://asardaes.github.io/table.express/articles/table.express.html">single-table verbs</a>, build <code>data.table</code> expressions.</p>
<div id="basic-joins" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-joins" class="anchor"></a>Basic joins</h2>
<p>We’ll consider most of the <code>dplyr</code> joining verbs in this section:</p>
<ul>
<li><code>inner_join</code></li>
<li><code>left_join</code></li>
<li><code>right_join</code></li>
<li><code>anti_join</code></li>
<li><code>semi_join</code></li>
<li><code>full_join</code></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">A &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">data.table</span>(<span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"c"</span>), <span class="dt">each =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">                            <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">6</span>),</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">                            <span class="dt">v =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">B &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">data.table</span>(<span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"c"</span>, <span class="st">"b"</span>),</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">                            <span class="dt">v2 =</span> <span class="dv">8</span><span class="op">:</span><span class="dv">7</span>,</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">                            <span class="dt">foo =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">4</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">A</a></code></pre></div>
<pre><code>#&gt;    x y v
#&gt; 1: b 1 1
#&gt; 2: b 3 2
#&gt; 3: b 6 3
#&gt; 4: a 1 4
#&gt; 5: a 3 5
#&gt; 6: a 6 6
#&gt; 7: c 1 7
#&gt; 8: c 3 8
#&gt; 9: c 6 9</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">B</a></code></pre></div>
<pre><code>#&gt;    x v2 foo
#&gt; 1: c  8   4
#&gt; 2: b  7   2</code></pre>
<p>The methods defined in <code>table.express</code> accept the <code>on</code> part of the expression in their ellipsis:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">A <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">inner_join</a></span>(B, x)</a></code></pre></div>
<pre><code>#&gt;    x y v v2 foo
#&gt; 1: c 1 7  8   4
#&gt; 2: c 3 8  8   4
#&gt; 3: c 6 9  8   4
#&gt; 4: b 1 1  7   2
#&gt; 5: b 3 2  7   2
#&gt; 6: b 6 3  7   2</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">A <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">inner_join</a></span>(B, x, <span class="dt">v =</span> v2)</a></code></pre></div>
<pre><code>#&gt;    x y v foo
#&gt; 1: c 3 8   4</code></pre>
<p>An important thing to note in the second example above is the order in which the columns are given, i.e. that <code>v</code> is written before <code>v2</code>, since the order is relevant for <code>data.table</code>. We can remember the correct order simply by looking at which <code>data.table</code> appears first in the expression, and knowing that said <code>data.table</code>’s columns must appear first in the <code>on</code> expressions. In this case, <code>A</code> appears before <code>B</code>, so writing <code>v2 = v</code> would not work.</p>
<p>In order to maintain consistency in the ordering just described, <code>left_join</code> automatically swaps expression elements internally in order to build the expression:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">A <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="st">    </span>start_expr <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(B, x, <span class="dt">v =</span> v2) <span class="op">%T&gt;%</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="st">    </span>print <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="st">    </span>end_expr</a></code></pre></div>
<pre><code>#&gt; .DT_[.DT_0_, on = list(x, v2 = v)]</code></pre>
<pre><code>#&gt;    x v2 foo y
#&gt; 1: b  1  NA 1
#&gt; 2: b  2  NA 3
#&gt; 3: b  3  NA 6
#&gt; 4: a  4  NA 1
#&gt; 5: a  5  NA 3
#&gt; 6: a  6  NA 6
#&gt; 7: c  7  NA 1
#&gt; 8: c  8   4 3
#&gt; 9: c  9  NA 6</code></pre>
<p>We can also see an extra <code>.DT_0_</code> pronoun in the expression. These special <code>.DT_*_</code> pronouns hold the different <code>data.table</code>s that have entered the expression so far, and are automatically assigned to the evaluation’s environment. In this case, <code>.DT_</code> holds <code>B</code> and <code>.DT_0_</code> holds <code>A</code>.</p>
<p>No additional considerations are required to use <code>right_join</code> or <code>anti_join</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">A <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">right_join</a></span>(B, x, <span class="dt">v =</span> v2)</a></code></pre></div>
<pre><code>#&gt;    x  y v foo
#&gt; 1: c  3 8   4
#&gt; 2: b NA 7   2</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">A <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">anti_join</a></span>(B, x, <span class="dt">v =</span> v2)</a></code></pre></div>
<pre><code>#&gt;    x y v
#&gt; 1: b 1 1
#&gt; 2: b 3 2
#&gt; 3: b 6 3
#&gt; 4: a 1 4
#&gt; 5: a 3 5
#&gt; 6: a 6 6
#&gt; 7: c 1 7
#&gt; 8: c 6 9</code></pre>
<p>A <code>semi_join</code> is essentially a <code>right_join</code> with <code>nomatch = NULL</code>, and where <code>j</code> is set to <code><a href="https://rdrr.io/r/base/unique.html">unique(.SD)</a></code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw">setnames</span>(B, <span class="st">"v2"</span>, <span class="st">"v"</span>)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"></a>
<a class="sourceLine" id="cb16-3" data-line-number="3">A <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">semi_join</a></span>(B, x)</a></code></pre></div>
<pre><code>#&gt;    x y v
#&gt; 1: c 1 7
#&gt; 2: c 3 8
#&gt; 3: c 6 9
#&gt; 4: b 1 1
#&gt; 5: b 3 2
#&gt; 6: b 6 3</code></pre>
<p>Finally, <code>full_join</code> is basically a wrapper for <code>merge</code> specifying <code>all = TRUE</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">A <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">full_join</a></span>(B, x)</a></code></pre></div>
<pre><code>#&gt;    x y v.x v.y foo
#&gt; 1: a 1   4  NA  NA
#&gt; 2: a 3   5  NA  NA
#&gt; 3: a 6   6  NA  NA
#&gt; 4: b 1   1   7   2
#&gt; 5: b 3   2   7   2
#&gt; 6: b 6   3   7   2
#&gt; 7: c 1   7   8   4
#&gt; 8: c 3   8   8   4
#&gt; 9: c 6   9   8   4</code></pre>
<div id="expression-chaining" class="section level3">
<h3 class="hasAnchor">
<a href="#expression-chaining" class="anchor"></a>Expression chaining</h3>
<p>Something to keep in mind is that most joins specify <code>i</code> and <code>on</code> inside the frame, so any subsequent verbs that specify <code>j</code>, <code>by</code>, or <code>keyby</code> would still be possible. In order to enable this, many joining verbs have an <code>.expr</code> parameter that indicates that the expression should be kept, delaying evaluation until a verb that sets <code>j</code> is used. This can be useful if only a subset of the joined columns is desired:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">A <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(B, x, <span class="dt">.expr =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(x, y, foo)</a></code></pre></div>
<pre><code>#&gt;    x y foo
#&gt; 1: b 1   2
#&gt; 2: b 3   2
#&gt; 3: b 6   2
#&gt; 4: a 1  NA
#&gt; 5: a 3  NA
#&gt; 6: a 6  NA
#&gt; 7: c 1   4
#&gt; 8: c 3   4
#&gt; 9: c 6   4</code></pre>
<p>But, when working lazily, this would require explicit chaining for expressions that should be applied to the joined table:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">A <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="st">    </span>start_expr <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(B, x) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="st">    </span>chain <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(x) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span>(y)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="st">    </span>end_expr <span class="op">%&gt;%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb22-8" data-line-number="8">        <span class="kw"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(.))</a>
<a class="sourceLine" id="cb22-9" data-line-number="9">    }</a></code></pre></div>
<pre><code>#&gt;    x  v foo  y i.v
#&gt; 1: b  7   2  1   1
#&gt; 2: b  7   2  4   2
#&gt; 3: b  7   2 10   3
#&gt; 4: a NA  NA  1   4
#&gt; 5: a NA  NA  4   5
#&gt; 6: a NA  NA 10   6
#&gt; 7: c  8   4  1   7
#&gt; 8: c  8   4  4   8
#&gt; 9: c  8   4 10   9</code></pre>
<p>This is particularly important if the selection expressions call any function, e.g. <code>tidyselect</code> helpers or even <code>:</code> with non-numerics, because <code>data.table</code> does not support that kind of syntax for <code>j</code> in the same frame as a join.</p>
</div>
</div>
<div id="mutating-join" class="section level2">
<h2 class="hasAnchor">
<a href="#mutating-join" class="anchor"></a>Mutating join</h2>
<p>A special <code>data.table</code> idiom is described <a href="https://stackoverflow.com/a/54313203/5793905">here as an update join</a>. In order to highlight the fact that it modifies the left-hand side table by reference, the <code>mutate_join</code> verb is defined in <code>table.express</code>. Said verb accepts the columns to be added in its <code>.SDcols</code> parameter, possibly with new names:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">A <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="../reference/joins.html">mutate_join</a></span>(B, x, <span class="dt">.SDcols =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"foo"</span>, <span class="dt">v_from_B =</span> <span class="st">"v"</span>))</a>
<a class="sourceLine" id="cb24-3" data-line-number="3"></a>
<a class="sourceLine" id="cb24-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(A)</a></code></pre></div>
<pre><code>#&gt;    x y v foo v_from_B
#&gt; 1: b 1 1   2        7
#&gt; 2: b 3 2   2        7
#&gt; 3: b 6 3   2        7
#&gt; 4: a 1 4  NA       NA
#&gt; 5: a 3 5  NA       NA
#&gt; 6: a 6 6  NA       NA
#&gt; 7: c 1 7   4        8
#&gt; 8: c 3 8   4        8
#&gt; 9: c 6 9   4        8</code></pre>
<p>A particularity of this idiom is that the number of rows from the resulting join must match the left-hand side exactly or not at all, so this won’t work:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">B <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="../reference/joins.html">mutate_join</a></span>(A, x, <span class="dt">.SDcols =</span> <span class="st">"y"</span>)</a></code></pre></div>
<pre><code>#&gt; Error in `[.data.table`(.DT_, , `:=`("y", A[.SD, list(y = x.y), on = list(x)])): Supplied 6 items to be assigned to 2 items of column 'y'. The RHS length must either be 1 (single values are ok) or match the LHS length exactly. If you wish to 'recycle' the RHS please use rep() explicitly to make this intent clear to readers of your code.</code></pre>
<p>In these cases, we must either use <code>mult</code> if appropriate, or specify a summarizing expression in <code>.SDcols</code>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">B <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="../reference/joins.html">mutate_join</a></span>(A, x, <span class="dt">.SDcols =</span> <span class="st">"y"</span>, <span class="dt">mult =</span> <span class="st">"first"</span>)</a>
<a class="sourceLine" id="cb28-3" data-line-number="3"></a>
<a class="sourceLine" id="cb28-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(B)</a></code></pre></div>
<pre><code>#&gt;    x v foo y
#&gt; 1: c 8   4 1
#&gt; 2: b 7   2 1</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">B <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="../reference/joins.html">mutate_join</a></span>(A, x, <span class="dt">.SDcols =</span> .(<span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(y)))</a>
<a class="sourceLine" id="cb30-3" data-line-number="3"></a>
<a class="sourceLine" id="cb30-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(B)</a></code></pre></div>
<pre><code>#&gt;    x v foo        y
#&gt; 1: c 8   4 3.333333
#&gt; 2: b 7   2 3.333333</code></pre>
<p>The last example specifies <code>by = .EACHI</code> in the joining expression.</p>
</div>
<div id="rolling-joins" class="section level2">
<h2 class="hasAnchor">
<a href="#rolling-joins" class="anchor"></a>Rolling joins</h2>
<p>A nice blog post describing rolling joins can be found at <a href="https://www.r-bloggers.com/understanding-data-table-rolling-joins/">R-bloggers</a>, so almost the same <code>website</code> and <code>paypal</code> tables will be used for the examples below. Another short description with animated depictions can also be found <a href="https://www.gormanalysis.com/blog/r-data-table-rolling-joins/">here</a>.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(website)</a></code></pre></div>
<pre><code>#&gt;        name  session_start_time session_id
#&gt;  1:   Erica 2016-01-04 19:12:00          1
#&gt;  2:   Erica 2016-01-04 21:05:00          2
#&gt;  3: Francis 2016-01-02 13:09:00          3
#&gt;  4: Francis 2016-01-03 19:22:00          4
#&gt;  5: Francis 2016-01-08 08:44:00          5
#&gt;  6: Francis 2016-01-08 20:22:00          6
#&gt;  7: Francis 2016-01-10 17:36:00          7
#&gt;  8: Francis 2016-01-15 16:56:00          8
#&gt;  9:  Isabel 2016-01-01 11:01:00          9
#&gt; 10:  Isabel 2016-01-02 08:59:00         10
#&gt; 11:  Isabel 2016-01-05 18:18:00         11
#&gt; 12:  Isabel 2016-01-07 19:03:00         12
#&gt; 13:  Isabel 2016-01-08 19:01:00         13
#&gt; 14:   Sally 2016-01-03 10:00:00         14
#&gt; 15:  Vivian 2016-01-01 09:10:00         15
#&gt; 16:  Vivian 2016-01-09 02:15:00         16</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(paypal)</a></code></pre></div>
<pre><code>#&gt;       name       purchase_time payment_id
#&gt; 1:   Erica 2016-01-03 08:02:00          1
#&gt; 2: Francis 2016-01-03 19:28:00          2
#&gt; 3: Francis 2016-01-08 20:33:00          3
#&gt; 4: Francis 2016-01-10 17:46:00          4
#&gt; 5:  Isabel 2016-01-08 19:10:00          5
#&gt; 6:     Mom 2015-12-02 17:58:00          6
#&gt; 7:   Sally 2016-01-03 10:06:00          7
#&gt; 8:   Sally 2016-01-03 10:15:00          8</code></pre>
<p>In contrast to the blog post, no <code>join_time</code> is added to the tables. This is done on purpose in order to show what happens with the columns that are rolled.</p>
<p>Let’s use a left rolling join to obtain the <code>session_id</code> that immediately preceded a purchase, if any:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">paypal <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(website, name, <span class="dt">purchase_time =</span> session_start_time, <span class="dt">roll =</span> <span class="ot">Inf</span>)</a></code></pre></div>
<pre><code>#&gt;       name  session_start_time session_id payment_id
#&gt; 1:   Erica 2016-01-03 08:02:00         NA          1
#&gt; 2: Francis 2016-01-03 19:28:00          4          2
#&gt; 3: Francis 2016-01-08 20:33:00          6          3
#&gt; 4: Francis 2016-01-10 17:46:00          7          4
#&gt; 5:  Isabel 2016-01-08 19:10:00         13          5
#&gt; 6:     Mom 2015-12-02 17:58:00         NA          6
#&gt; 7:   Sally 2016-01-03 10:06:00         14          7
#&gt; 8:   Sally 2016-01-03 10:15:00         14          8</code></pre>
<p>We can see that the rows returned are from the left-hand side (<code>paypal</code>), and since neither Mom nor Erica visited the website before their purchases, their <code>session_id</code> ended as <code>NA</code>.</p>
<p>The order of the columns in the <code>on</code> expressions is the same as <a href="#basic-joins">above</a>. The tricky part is that the rolled column ended up with the name from the right-hand side, but keeping the values from the left-hand side. If we “invert” the join, the result is the same, but the rolled column’s name is now from the expression’s left-hand side.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1">website <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">right_join</a></span>(paypal, name, <span class="dt">session_start_time =</span> purchase_time, <span class="dt">roll =</span> <span class="ot">Inf</span>)</a></code></pre></div>
<pre><code>#&gt;       name  session_start_time session_id payment_id
#&gt; 1:   Erica 2016-01-03 08:02:00         NA          1
#&gt; 2: Francis 2016-01-03 19:28:00          4          2
#&gt; 3: Francis 2016-01-08 20:33:00          6          3
#&gt; 4: Francis 2016-01-10 17:46:00          7          4
#&gt; 5:  Isabel 2016-01-08 19:10:00         13          5
#&gt; 6:     Mom 2015-12-02 17:58:00         NA          6
#&gt; 7:   Sally 2016-01-03 10:06:00         14          7
#&gt; 8:   Sally 2016-01-03 10:15:00         14          8</code></pre>
<p>Note, however, that <code>roll</code> stayed equal to <code>Inf</code>. This is because even though the column order in the expressions changed, we could understand the rolling expressions as follows:</p>
<ul>
<li>For <code>left_join</code>, the rolling column on the left is <code>purchase_time</code>, so with <code>roll = Inf</code>, the values from <code>session_start_time</code> are rolled forward onto <code>purchase_time</code> to find a match while joining.</li>
<li>For <code>right_join</code>, the rolling column on the right is <code>purchase_time</code>, so <code>roll</code> must stay as <code>Inf</code> to keep the same semantics.</li>
</ul>
<p>Now let’s say we want to keep all the rows from <code>website</code> and find the closest <code>payment_id</code> that occurred <em>after</em> the visit. This could be expressed as:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1">website <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(paypal, name, <span class="dt">session_start_time =</span> purchase_time, <span class="dt">roll =</span> <span class="op">-</span><span class="ot">Inf</span>)</a></code></pre></div>
<pre><code>#&gt;        name       purchase_time payment_id session_id
#&gt;  1:   Erica 2016-01-04 19:12:00         NA          1
#&gt;  2:   Erica 2016-01-04 21:05:00         NA          2
#&gt;  3: Francis 2016-01-02 13:09:00          2          3
#&gt;  4: Francis 2016-01-03 19:22:00          2          4
#&gt;  5: Francis 2016-01-08 08:44:00          3          5
#&gt;  6: Francis 2016-01-08 20:22:00          3          6
#&gt;  7: Francis 2016-01-10 17:36:00          4          7
#&gt;  8: Francis 2016-01-15 16:56:00         NA          8
#&gt;  9:  Isabel 2016-01-01 11:01:00          5          9
#&gt; 10:  Isabel 2016-01-02 08:59:00          5         10
#&gt; 11:  Isabel 2016-01-05 18:18:00          5         11
#&gt; 12:  Isabel 2016-01-07 19:03:00          5         12
#&gt; 13:  Isabel 2016-01-08 19:01:00          5         13
#&gt; 14:   Sally 2016-01-03 10:00:00          7         14
#&gt; 15:  Vivian 2016-01-01 09:10:00         NA         15
#&gt; 16:  Vivian 2016-01-09 02:15:00         NA         16</code></pre>
<p>In order to simplify the meaning of <code>rollends</code> a bit, we could think of it as missing or being a single <code>TRUE</code>/<code>FALSE</code>. If it’s missing, rolling works according to the value of <code>roll</code>, otherwise:</p>
<ul>
<li>When <code>rollends = TRUE</code>, the value of <code>roll</code> is inverted <em>only</em> for those rows that would have no match otherwise.</li>
<li>When <code>rollends = FALSE</code>, a matching roll will only occur if the column’s value falls in a gap with values both before <em>and</em> after.</li>
</ul>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">website <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(paypal, name, <span class="dt">session_start_time =</span> purchase_time, <span class="dt">roll =</span> <span class="op">-</span><span class="ot">Inf</span>, <span class="dt">rollends =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>#&gt;        name       purchase_time payment_id session_id
#&gt;  1:   Erica 2016-01-04 19:12:00          1          1
#&gt;  2:   Erica 2016-01-04 21:05:00          1          2
#&gt;  3: Francis 2016-01-02 13:09:00          2          3
#&gt;  4: Francis 2016-01-03 19:22:00          2          4
#&gt;  5: Francis 2016-01-08 08:44:00          3          5
#&gt;  6: Francis 2016-01-08 20:22:00          3          6
#&gt;  7: Francis 2016-01-10 17:36:00          4          7
#&gt;  8: Francis 2016-01-15 16:56:00          4          8
#&gt;  9:  Isabel 2016-01-01 11:01:00          5          9
#&gt; 10:  Isabel 2016-01-02 08:59:00          5         10
#&gt; 11:  Isabel 2016-01-05 18:18:00          5         11
#&gt; 12:  Isabel 2016-01-07 19:03:00          5         12
#&gt; 13:  Isabel 2016-01-08 19:01:00          5         13
#&gt; 14:   Sally 2016-01-03 10:00:00          7         14
#&gt; 15:  Vivian 2016-01-01 09:10:00         NA         15
#&gt; 16:  Vivian 2016-01-09 02:15:00         NA         16</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1">website <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb44-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(paypal, name, <span class="dt">session_start_time =</span> purchase_time, <span class="dt">roll =</span> <span class="op">-</span><span class="ot">Inf</span>, <span class="dt">rollends =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>#&gt;        name       purchase_time payment_id session_id
#&gt;  1:   Erica 2016-01-04 19:12:00         NA          1
#&gt;  2:   Erica 2016-01-04 21:05:00         NA          2
#&gt;  3: Francis 2016-01-02 13:09:00         NA          3
#&gt;  4: Francis 2016-01-03 19:22:00         NA          4
#&gt;  5: Francis 2016-01-08 08:44:00          3          5
#&gt;  6: Francis 2016-01-08 20:22:00          3          6
#&gt;  7: Francis 2016-01-10 17:36:00          4          7
#&gt;  8: Francis 2016-01-15 16:56:00         NA          8
#&gt;  9:  Isabel 2016-01-01 11:01:00         NA          9
#&gt; 10:  Isabel 2016-01-02 08:59:00         NA         10
#&gt; 11:  Isabel 2016-01-05 18:18:00         NA         11
#&gt; 12:  Isabel 2016-01-07 19:03:00         NA         12
#&gt; 13:  Isabel 2016-01-08 19:01:00         NA         13
#&gt; 14:   Sally 2016-01-03 10:00:00         NA         14
#&gt; 15:  Vivian 2016-01-01 09:10:00         NA         15
#&gt; 16:  Vivian 2016-01-09 02:15:00         NA         16</code></pre>
<p>Vivian’s <code>payment_id</code>s are always <code>NA</code> because she has never purchased anything. On the other hand, no one except Francis has visited the website both before and after a purchase.</p>
</div>
<div id="non-equi-joins" class="section level2">
<h2 class="hasAnchor">
<a href="#non-equi-joins" class="anchor"></a>Non-equi joins</h2>
<p>Non-equi joins are similar to rolling joins, but instead of rolling a single row’s value, they can return several values per row.</p>
<p>Using the same data as before, we could find <em>all</em> the <code>session_id</code>s that preceded a <code>payment_id</code>, giving “priority” to <code>paypal</code>’s rows:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1">paypal <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(website, name, purchase_time <span class="op">&gt;=</span><span class="st"> </span>session_start_time)</a></code></pre></div>
<pre><code>#&gt;        name  session_start_time session_id payment_id
#&gt;  1:   Erica 2016-01-03 08:02:00         NA          1
#&gt;  2: Francis 2016-01-03 19:28:00          3          2
#&gt;  3: Francis 2016-01-03 19:28:00          4          2
#&gt;  4: Francis 2016-01-08 20:33:00          3          3
#&gt;  5: Francis 2016-01-08 20:33:00          4          3
#&gt;  6: Francis 2016-01-08 20:33:00          5          3
#&gt;  7: Francis 2016-01-08 20:33:00          6          3
#&gt;  8: Francis 2016-01-10 17:46:00          3          4
#&gt;  9: Francis 2016-01-10 17:46:00          4          4
#&gt; 10: Francis 2016-01-10 17:46:00          5          4
#&gt; 11: Francis 2016-01-10 17:46:00          6          4
#&gt; 12: Francis 2016-01-10 17:46:00          7          4
#&gt; 13:  Isabel 2016-01-08 19:10:00          9          5
#&gt; 14:  Isabel 2016-01-08 19:10:00         10          5
#&gt; 15:  Isabel 2016-01-08 19:10:00         11          5
#&gt; 16:  Isabel 2016-01-08 19:10:00         12          5
#&gt; 17:  Isabel 2016-01-08 19:10:00         13          5
#&gt; 18:     Mom 2015-12-02 17:58:00         NA          6
#&gt; 19:   Sally 2016-01-03 10:06:00         14          7
#&gt; 20:   Sally 2016-01-03 10:15:00         14          8</code></pre>
<p>Priority above simply means that all rows from <code>paypal</code> are returned, even if they don’t have a match in <code>website</code>. Even though a column <code>session_start_time</code> appears in the result, the values contained therein are from <code>paypal</code>’s <code>purchase_time</code>.</p>
<p>A corresponding right non-equi join would yield the same result, expecting only a different order in the columns that are part of the comparisons:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1">website <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">right_join</a></span>(paypal, name, session_start_time <span class="op">&lt;=</span><span class="st"> </span>purchase_time)</a></code></pre></div>
<pre><code>#&gt;        name  session_start_time session_id payment_id
#&gt;  1:   Erica 2016-01-03 08:02:00         NA          1
#&gt;  2: Francis 2016-01-03 19:28:00          3          2
#&gt;  3: Francis 2016-01-03 19:28:00          4          2
#&gt;  4: Francis 2016-01-08 20:33:00          3          3
#&gt;  5: Francis 2016-01-08 20:33:00          4          3
#&gt;  6: Francis 2016-01-08 20:33:00          5          3
#&gt;  7: Francis 2016-01-08 20:33:00          6          3
#&gt;  8: Francis 2016-01-10 17:46:00          3          4
#&gt;  9: Francis 2016-01-10 17:46:00          4          4
#&gt; 10: Francis 2016-01-10 17:46:00          5          4
#&gt; 11: Francis 2016-01-10 17:46:00          6          4
#&gt; 12: Francis 2016-01-10 17:46:00          7          4
#&gt; 13:  Isabel 2016-01-08 19:10:00          9          5
#&gt; 14:  Isabel 2016-01-08 19:10:00         10          5
#&gt; 15:  Isabel 2016-01-08 19:10:00         11          5
#&gt; 16:  Isabel 2016-01-08 19:10:00         12          5
#&gt; 17:  Isabel 2016-01-08 19:10:00         13          5
#&gt; 18:     Mom 2015-12-02 17:58:00         NA          6
#&gt; 19:   Sally 2016-01-03 10:06:00         14          7
#&gt; 20:   Sally 2016-01-03 10:15:00         14          8</code></pre>
</div>
<div id="self-joins" class="section level2">
<h2 class="hasAnchor">
<a href="#self-joins" class="anchor"></a>Self joins</h2>
<p>In case a self join were necessary, perhaps while using a rolling or non-equi join, the way <code>magrittr</code>’s pipe handles the <code>.</code> outside of nested calls wouldn’t allow calling a joining verb with <code>.</code> both in <code>x</code> and <code>y</code>. To work around this, the following verbs default to an eager self join when <code>y</code> is missing:</p>
<ul>
<li><code>full_join</code></li>
<li><code>left_join</code></li>
<li><code>mutate_join</code></li>
</ul>
<p>As a somewhat contrived example, we could add a rolling count of weekly visits per user to the <code>website</code> data introduced <a href="#rolling-joins">above</a>:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1">website <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">window_start =</span> session_start_time <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/difftime.html">as.difftime</a></span>(<span class="dv">7</span>, <span class="dt">units =</span> <span class="st">"days"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="../reference/joins.html">mutate_join</a></span>(, name, window_start <span class="op">&lt;=</span><span class="st"> </span>session_start_time, session_start_time <span class="op">&gt;=</span><span class="st"> </span>session_start_time,</a>
<a class="sourceLine" id="cb50-4" data-line-number="4">                <span class="dt">.SDcols =</span> .(<span class="dt">weekly_visits =</span> .N),</a>
<a class="sourceLine" id="cb50-5" data-line-number="5">                <span class="dt">.by_each =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-6" data-line-number="6"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">window_start =</span> <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb50-7" data-line-number="7"></a>
<a class="sourceLine" id="cb50-8" data-line-number="8"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(website)</a></code></pre></div>
<pre><code>#&gt;        name  session_start_time session_id weekly_visits
#&gt;  1:   Erica 2016-01-04 19:12:00          1             1
#&gt;  2:   Erica 2016-01-04 21:05:00          2             2
#&gt;  3: Francis 2016-01-02 13:09:00          3             1
#&gt;  4: Francis 2016-01-03 19:22:00          4             2
#&gt;  5: Francis 2016-01-08 08:44:00          5             3
#&gt;  6: Francis 2016-01-08 20:22:00          6             4
#&gt;  7: Francis 2016-01-10 17:36:00          7             4
#&gt;  8: Francis 2016-01-15 16:56:00          8             3
#&gt;  9:  Isabel 2016-01-01 11:01:00          9             1
#&gt; 10:  Isabel 2016-01-02 08:59:00         10             2
#&gt; 11:  Isabel 2016-01-05 18:18:00         11             3
#&gt; 12:  Isabel 2016-01-07 19:03:00         12             4
#&gt; 13:  Isabel 2016-01-08 19:01:00         13             4
#&gt; 14:   Sally 2016-01-03 10:00:00         14             1
#&gt; 15:  Vivian 2016-01-01 09:10:00         15             1
#&gt; 16:  Vivian 2016-01-09 02:15:00         16             1</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#basic-joins">Basic joins</a></li>
      <li><a href="#mutating-join">Mutating join</a></li>
      <li><a href="#rolling-joins">Rolling joins</a></li>
      <li><a href="#non-equi-joins">Non-equi joins</a></li>
      <li><a href="#self-joins">Self joins</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Alexis Sarda-Espinosa.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9100.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
